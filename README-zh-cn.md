目前最常用的轮转算法 (rotation algorithms)（也称：块交换算法, block swaps）最早于 1981 年有记录，这么多年来并没有大的改进。

以下我会介绍一些轮转算法的变种，特别是连体三重反转轮转(Conjoined Triple Reversal Rotation)，并附上性能测试的结果图。


## 专有名词对照表
+ rotation, rotating: 轮转
+ circshift: 循环移位

## 轮转算法简介

轮转 (rotating) 指的是将一个数组的左右侧对调。这是一种在很多排序算法中常用的操作。
```c
┌──────────────────────────┬─────────────────┐
│ 1  2  3  4  5  6  7  8  9│10 11 12 13 14 15│
└──────────────────────────┴─────────────────┘
```
上面的数组经过轮转后变成下面这个样子：
```c
┌─────────────────┬──────────────────────────┐
│10 11 12 13 14 15│ 1  2  3  4  5  6  7  8  9│
└─────────────────┴──────────────────────────┘
```

## 辅助空间轮转
辅助（空间）轮转 (Auxiliary Rotation) 是一种简单而快速的轮转方式，但由于它需要临时的辅助空间。

通常情况下，较小的一半被复制到辅助空间，较大的一半被移动，然后将辅助空间复制回主数组。
```c
┌──────────────────────────┬─────────────────┐
│ 1  2  3  4  5  6  7  8  9│10 11 12 13 14 15│
└──────────────────────────┴─────────────────┘
                             ↑  ↑  ↑  ↑  ↑  ↑    ↓  ↓  ↓  ↓  ↓  ↓
┌──────────────────────────┬─────────────────┐ ┌─────────────────┐
│ 1  2  3  4  5  6  7  8  9│                 │ │10 11 12 13 14 15│
└──────────────────────────┴─────────────────┘ └─────────────────┘
  ↑  ↑  ↑  ↑  ↑  ↑  ↑  ↑  ↑
                    ↓  ↓  ↓  ↓  ↓  ↓  ↓  ↓  ↓
┌─────────────────┬──────────────────────────┐ ┌─────────────────┐
│                 │ 1  2  3  4  5  6  7  8  9│ │10 11 12 13 14 15│
└─────────────────┴──────────────────────────┘ └─────────────────┘
  ↓  ↓  ↓  ↓  ↓  ↓                               ↑  ↑  ↑  ↑  ↑  ↑
┌─────────────────┬──────────────────────────┐
│10 11 12 13 14 15│ 1  2  3  4  5  6  7  8  9│
└─────────────────┴──────────────────────────┘
```

## 桥轮转
桥轮转 (Bridge Rotation) 是一种更复杂辅助空间轮转算法，它将所需的最大辅助空间大小从 50% 缩减至 33%。

如果两半之间的重叠部分小于两半本身，它会将重叠部分复制到交换内存中。
如果重叠部分大于两半中较小的那部分，则将较小的那部分复制到交换内存中。
```c
┌──────────────────────────┬─────────────────┐
│ 1  2  3  4  5  6  7  8  9│10 11 12 13 14 15│
└──────────────────────────┴─────────────────┘
                    ↑  ↑  ↑                      ↓  ↓  ↓
┌─────────────────┬────────┬─────────────────┐ ┌────────┐
│ 1  2  3  4  5  6│        │10 11 12 13 14 15│ │ 7  8  9│
└─────────────────┴────────┴─────────────────┘ └────────┘
  ↑  ↑  ↑  ↑  ↑  ↑           ↑  ↑  ↑  ↑  ↑  ↑
  ↓  ↓  ↓  ↓  ↓  ↓  ↓  ↓  ↓  ↓  ↓  ↓
┌─────────────────┬──────────────────────────┐ ┌────────┐
│10 11 12 13 14 15│ 1  2  3  4  5  6         │ │ 7  8  9│
└─────────────────┴──────────────────────────┘ └────────┘
                                      ↓  ↓  ↓    ↑  ↑  ↑
┌─────────────────┬──────────────────────────┐
│10 11 12 13 14 15│ 1  2  3  4  5  6  7  8  9│
└─────────────────┴──────────────────────────┘
```

## Bentley 的杂耍轮转

本特利的杂耍轮转 (Bentley's Juggling Rotation) 也称海豚算法 (dolphin algorithm)，首次发表是在1965年。
这是一种相对复杂且缓存效率低下的原地轮转算法，尽管它以最小的移动量完成了轮转。

它计算出最大公因子，并使用一个循环来构造出一个连续的交换链。
```c
┌──────────────────────────┬─────────────────┐
│ 1  2  3  4  5  6  7  8  9│10 11 12 13 14 15│
└──────────────────────────┴─────────────────┘
  ↓        ↓        ↓        ↓        ↓
┌──────────────────────────┬─────────────────┐
│10  2  3 13  5  6  1  8  9│ 4 11 12  7 14 15│
└──────────────────────────┴─────────────────┘
     ↓        ↓        ↓        ↓        ↓
┌──────────────────────────┬─────────────────┐
│10 11  3 13 14  6  1  2  9│ 4  5 12  7  8 15│
└──────────────────────────┴─────────────────┘
        ↓        ↓        ↓        ↓        ↓
┌─────────────────┬──────────────────────────┐
│10 11 12 13 14 15│ 1  2  3  4  5  6  7  8  9│
└─────────────────┴──────────────────────────┘
```

## 三重反转轮转
三重反转轮转 (Triple Reversal Rotation) 这是一种简单而可靠的原地轮转的方法。
你把左边的反转，然后把右边的反转，最后把整个阵列反转。
三次反转完成后，左右两侧的块完成交换。

```c
┌──────────────────────────┬─────────────────┐
│ 1  2  3  4  5  6  7  8  9│10 11 12 13 14 15│
└──────────────────────────┴─────────────────┘
  ↓  ↓  ↓  ↓  ↓  ↓  ↓  ↓  ↓
┌──────────────────────────┬─────────────────┐
│ 9  8  7  6  5  4  3  2  1│10 11 12 13 14 15│
└──────────────────────────┴─────────────────┘
                             ↓  ↓  ↓  ↓  ↓  ↓
┌──────────────────────────┬─────────────────┐
│ 9  8  7  6  5  4  3  2  1│15 14 13 12 11 10│
└──────────────────────────┴─────────────────┘
  ↓  ↓  ↓  ↓  ↓  ↓  ↓  ↓  ↓  ↓  ↓  ↓  ↓  ↓  ↓
┌─────────────────┬──────────────────────────┐
│10 11 12 13 14 15│ 1  2  3  4  5  6  7  8  9│
└─────────────────┴──────────────────────────┘
```

## Gries-Mills 轮转
它的首次发表是在 1981 年。
你把最小的数组交换到适当的位置，因为它在适当的位置，所以你可以忽略它。
更大的数组现在被分成两部分，一部分已经完成轮转，一部分还没有。
你以类似的方式继续交换，直到待轮转的一段长度为0。

```c
┌──────────────────────────┬──────────────────┐
│ 1  2  3  4  5  6  7  8  9│10 11 12  13 14 15│
└──────────────────────────┴──────────────────┘
  ↓  ↓  ↓   ↓  ↓  ↓          ↑  ↑  ↑   ↑  ↑  ↑
┌─────────────────┬────────┬──────────────────┐
│10 11 12 13 14 15│ 7  8  9│ 1  2  3   4  5  6│
└─────────────────┴────────┴──────────────────┘
                    ↑  ↑  ↑            ↓  ↓  ↓
┌─────────────────┬────────┬────────┬─────────┐
│10 11 12 13 14 15│ 4  5  6│ 1  2  3│  7  8  9│
└─────────────────┴────────┴────────┴─────────┘
                    ↓  ↓  ↓  ↑  ↑  ↑
┌─────────────────┬───────────────────────────┐
│10 11 12 13 14 15│ 1  2  3  4  5  6   7  8  9│
└─────────────────┴───────────────────────────┘
```

## 圣杯轮转
圣杯轮转 (Grail Rotation) 来自圣杯排序项目 (Holy Grail Sort Project)，由 Gries-Mills 轮转算法派生。
它试图通过将内存向左或向右移动来提高定位性，这取决于它从哪一侧交换。
此外，当最小的一边达到1个元素的大小时，它在堆栈内存上执行辅助轮转。

## 烧杯轮转
烧杯轮转 (Beaker Rotation) 烧杯轮转是由圣杯轮转的，并使用取模计算来减少循环的数量。
当两半之间的相对大小差异较大时，这提高了性能。

## 连体三重反转轮转
连体三重反转 (Conjoined Triple Reversal Rotation)，又称三位一体轮转 (trinity rotation)，由三重轮转派生出来。
它不是三个单独的轮转，而是将三个轮转连在一起，提高了局部性并减少了移动的数量。
可选的是，如果较小的半边小于8个元素，它将跳过三位一体轮转，在堆栈内存上执行一个辅助轮转。

```c
┌──────────────────────────┬─────────────────┐
│ 1  2  3  4  5  6  7  8  9│10 11 12 13 14 15│
└──────────────────────────┴─────────────────┘
  ↓                       ↓  ↓              ↓
┌──────────────────────────┬─────────────────┐
│10  2  3  4  5  6  7  8  1│15 11 12 13 14  9│
└──────────────────────────┴─────────────────┘
     ↓                 ↓        ↓        ↓
┌──────────────────────────┬─────────────────┐
│10 11  3  4  5  6  7  2  1│15 14 12 13  8  9│
└──────────────────────────┴─────────────────┘
        ↓           ↓              ↓  ↓
┌──────────────────────────┬─────────────────┐
│10 11 12  4  5  6  3  2  1│15 14 13  7  8  9│
└──────────────────────────┴─────────────────┘
           ↓     ↓                 ↓
┌──────────────────────────┬─────────────────┐
│10 11 12 13  5  4  3  2  1│15 14  6  7  8  9│
└──────────────────────────┴─────────────────┘
              ↓                 ↓
┌──────────────────────────┬─────────────────┐
│10 11 12 13 14  4  3  2  1│15  5  6  7  8  9│
└──────────────────────────┴─────────────────┘
                 ↓           ↓
┌──────────────────────────┬─────────────────┐
│10 11 12 13 14 15  3  2  1│ 4  5  6  7  8  9│
└──────────────────────────┴─────────────────┘
                    ↓     ↓
┌─────────────────┬──────────────────────────┐
│10 11 12 13 14 15│ 1  2  3  4  5  6  7  8  9│
└─────────────────┴──────────────────────────┘
```


## 性能测试
由于杂耍(juggling)轮转相当慢。
而"辅助空间(auxiliary)"/"桥(bridge)"和"圣杯(grail)"/"烧杯(beaker)"速度相当相似。
我从基准中省略了辅助空间(auxiliary)、杂耍(juggling)和圣杯(grail)轮转算法。

虽然性能可能因具体实现而不同，但从最差到最好的顺序是：
* 杂耍轮转 (juggling)
* 三重反转轮转 (reversal)
* 圣杯轮转 (grail)
* 烧杯轮转 (beaker)
* 辅助空间轮转 (auxiliary)
* 桥轮转 (bridge)
* 三位一体轮转 (trinity)

需要注意的是，对于较小的数组和两半之间的相对大小差异较大时，辅助空间轮转的表现更好。

下面的基准测试是在 WSL 2 gcc 7.5.0 版 (Ubuntu 7.5.0-3ubuntu1~18.04) 上进行的。
源代码是用 `gcc -O3 bench.c` 编译的。
每个测试都运行了 1000 次，并报告了最佳和平均运行的时间（单位：秒）。


![rotation graph](/graph1.png)

<details><summary><b>data table</b></summary>

|      Name |    Items | Type |     Best |  Average |     Loops | Samples |     Distribution |
| --------- | -------- | ---- | -------- | -------- | --------- | ------- | ---------------- |
| auxiliary |  1000000 |   32 | 0.000364 | 0.000394 |         1 |    1000 |         1/999999 |
|    beaker |  1000000 |   32 | 0.000364 | 0.000392 |         1 |    1000 |         1/999999 |
|    bridge |  1000000 |   32 | 0.000365 | 0.000386 |         1 |    1000 |         1/999999 |
|     grail |  1000000 |   32 | 0.000363 | 0.000386 |         1 |    1000 |         1/999999 |
|  juggling |  1000000 |   32 | 0.000603 | 0.000630 |         1 |    1000 |         1/999999 |
|   trinity |  1000000 |   32 | 0.000362 | 0.000384 |         1 |    1000 |         1/999999 |
|  reversal |  1000000 |   32 | 0.000520 | 0.000553 |         1 |    1000 |         1/999999 |
|           |          |      |          |          |           |         |                  |
| auxiliary |  1000000 |   32 | 0.000434 | 0.000460 |         1 |    1000 |    100000/900000 |
|    beaker |  1000000 |   32 | 0.000455 | 0.000479 |         1 |    1000 |    100000/900000 |
|    bridge |  1000000 |   32 | 0.000436 | 0.000460 |         1 |    1000 |    100000/900000 |
|     grail |  1000000 |   32 | 0.000457 | 0.000481 |         1 |    1000 |    100000/900000 |
|  juggling |  1000000 |   32 | 0.000632 | 0.000657 |         1 |    1000 |    100000/900000 |
|   trinity |  1000000 |   32 | 0.000420 | 0.000445 |         1 |    1000 |    100000/900000 |
|  reversal |  1000000 |   32 | 0.000513 | 0.000543 |         1 |    1000 |    100000/900000 |
|           |          |      |          |          |           |         |                  |
| auxiliary |  1000000 |   32 | 0.000471 | 0.000501 |         1 |    1000 |    199999/800001 |
|    beaker |  1000000 |   32 | 0.000676 | 0.000702 |         1 |    1000 |    199999/800001 |
|    bridge |  1000000 |   32 | 0.000471 | 0.000492 |         1 |    1000 |    199999/800001 |
|     grail |  1000000 |   32 | 0.000635 | 0.000668 |         1 |    1000 |    199999/800001 |
|  juggling |  1000000 |   32 | 0.000798 | 0.000831 |         1 |    1000 |    199999/800001 |
|   trinity |  1000000 |   32 | 0.000435 | 0.000460 |         1 |    1000 |    199999/800001 |
|  reversal |  1000000 |   32 | 0.000522 | 0.000557 |         1 |    1000 |    199999/800001 |
|           |          |      |          |          |           |         |                  |
| auxiliary |  1000000 |   32 | 0.000525 | 0.000552 |         1 |    1000 |    299998/700002 |
|    beaker |  1000000 |   32 | 0.000498 | 0.000524 |         1 |    1000 |    299998/700002 |
|    bridge |  1000000 |   32 | 0.000521 | 0.000545 |         1 |    1000 |    299998/700002 |
|     grail |  1000000 |   32 | 0.000521 | 0.000548 |         1 |    1000 |    299998/700002 |
|  juggling |  1000000 |   32 | 0.001943 | 0.001991 |         1 |    1000 |    299998/700002 |
|   trinity |  1000000 |   32 | 0.000437 | 0.000474 |         1 |    1000 |    299998/700002 |
|  reversal |  1000000 |   32 | 0.000520 | 0.000575 |         1 |    1000 |    299998/700002 |
|           |          |      |          |          |           |         |                  |
| auxiliary |  1000000 |   32 | 0.000567 | 0.000606 |         1 |    1000 |    399997/600003 |
|    beaker |  1000000 |   32 | 0.000522 | 0.000549 |         1 |    1000 |    399997/600003 |
|    bridge |  1000000 |   32 | 0.000512 | 0.000532 |         1 |    1000 |    399997/600003 |
|     grail |  1000000 |   32 | 0.000550 | 0.000578 |         1 |    1000 |    399997/600003 |
|  juggling |  1000000 |   32 | 0.001744 | 0.001788 |         1 |    1000 |    399997/600003 |
|   trinity |  1000000 |   32 | 0.000435 | 0.000465 |         1 |    1000 |    399997/600003 |
|  reversal |  1000000 |   32 | 0.000518 | 0.000554 |         1 |    1000 |    399997/600003 |
|           |          |      |          |          |           |         |                  |
| auxiliary |  1000000 |   32 | 0.000609 | 0.000651 |         1 |    1000 |    499996/500004 |
|    beaker |  1000000 |   32 | 0.000468 | 0.000498 |         1 |    1000 |    499996/500004 |
|    bridge |  1000000 |   32 | 0.000377 | 0.000397 |         1 |    1000 |    499996/500004 |
|     grail |  1000000 |   32 | 0.000796 | 0.000828 |         1 |    1000 |    499996/500004 |
|  juggling |  1000000 |   32 | 0.001084 | 0.001124 |         1 |    1000 |    499996/500004 |
|   trinity |  1000000 |   32 | 0.000376 | 0.000401 |         1 |    1000 |    499996/500004 |
|  reversal |  1000000 |   32 | 0.000513 | 0.000545 |         1 |    1000 |    499996/500004 |

</details>
